<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Policies for your Apps with Open Policy Agent framework</title>

		<!-- bootstrap -->
		<link rel="stylesheet" href="ext/bootstrap-5.1.3-dist/css/bootstrap.css">
		<!-- -->

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">

		<!-- remove annoying shadow around images -->
		<style>
			.reveal section img {
				background-color:white;
				border:0;
				box-shadow: 0 0 0 0;
			}
		</style>
		<!-- -->
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<!-- p>U<span style="text-transform: lowercase;">sługi i platformy dew dla aplikacji<br /> w Chmurze</span></p -->

					<h3>A<span style="text-transform: lowercase;">dding</span> P<span style="text-transform: lowercase;">olicies to your </span>G<span style="text-transform: lowercase;">olang App<br /> with</span> O<span style="text-transform: lowercase;">pen</span> P<span style="text-transform: lowercase;">olicy </span>A<span style="text-transform: lowercase;">gent framework</span></h3>

					<img width="20%" src="img/opa-no-text-color.png" />

					<h6><small>W<span style="text-transform: lowercase;">ojciech</span> B<span style="text-transform: lowercase;">arczyński</span>, VP <span style="text-transform: lowercase;">of</span> E<span style="text-transform: lowercase;">ngineering</span><br />
							<span style="text-transform: lowercase;">wojciechb@spacelift.io</span></small>
				</section>

				<section>
					<h3>P<span style="text-transform: lowercase;">roblem</span></h3>
					<div class="container">
						<div class="row">
							<div class='col-md-6'>
								<p>Chasing the rabbit:</p>
								<ul>
									<li>Policies</li>
									<li>Configuration</li>
									<li>but also product plans and features</li>
								</ul>
							</div>
							<div class='col-md-6'>
								<img width="100%" style="object-fit: fill;" src="img/rabbit_3778903507_a80007400b_c.jpg" />
							</div>
						</div>
					</div>
				</section>

							<section>
					<h3>B<span style="text-transform: lowercase;">uilding your own app</span></h3>
					<div class="container">
						<div class="row">
							<div class='col-md-5'>
								<p>Spacelift.io:</p>
								<ul>
									<li>SaaS continuous Deployment<br />for Infra-as-a-Code</li>
									<li>Power users</li>
								</ul>
							</div>
							<div class='col-md-7'>
								<img width="100%" style="object-fit: fill;" src="https://1737839032-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LshwwDZmA4HXN0k9e8O%2Fuploads%2Fw2sPZz6sRrgalfBd3PV3%2FScreen%20Shot%202022-06-29%20at%202.47.11%20PM.png?alt=media&token=244f5ab7-7922-434b-a539-203af6840ecd" />
							</div>
						</div>
					</div>
				</section>

				<!-- Spacelift helps you to continuously deploy your IaC, open your cloud resources to the large part of your engineering organization, work collaboratively with them, and do it all in a safe and auditable way -->

				<!-- section data-markdown>
					<script type="text/template">
### C<span style="text-transform: lowercase;">hallenge</span>

At Spacelift:

- We build an Infra-as-a-Code SaaS for power users.
- We need a safe and flexible way for users to customize our platform
					</script>
				</section -->

				<section data-markdown>
					<script type="text/template">
### P<span style="text-transform: lowercase;">otential solutions</span>

- Endless forms
- Markup language
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### P<span style="text-transform: lowercase;">otential solutions</span>

- Scripting language embedded
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### P<span style="text-transform: lowercase;">olicy-as-a-code</span>

- Dedicated language with safety guarantees
- Work on loosly structured data
- JSON support
					</script>
				</section>

				<section>
					<h3>O<span style="text-transform: lowercase;">pen</span> P<span style="text-transform: lowercase;">olicy</span> A<span style="text-transform: lowercase;">gent</span></h3>
					<div class="container">
						<div class="row">
							<div class='col-md-6 '>
								<p><ol>
									<li>Rego - query/transformation language;</li>
									<li>Works on loosly structured</li>
									<li>JSON support</li>
								</ol></p>
							</div>
							<div class='col-md-6'>
								<img width="100%" style="object-fit: fill;" src="img/opa-service.svg" />
							</div>
						</div>
					</div>
				</section>

				<section>
					<h4>O<span style="text-transform: lowercase;">pen</span> P<span style="text-transform: lowercase;">olicy</span> A<span style="text-transform: lowercase;">gent</span></h4>
					<div class="container">
						<div class="row">
							<div class='col-md-5'>
								<img width="55%" src="img/opa-no-text-color.png" />
								<p><smalL>Created by<br /><img src="https://d33wubrfki0l68.cloudfront.net/ce60c030ed59a4a5e5809aadbaf79f8ed13bcb67/b825f/img/styra-logo.jpg" /></small></p>
								<p><small><a href="https://www.openpolicyagent.org/">openpolicyagent.org</a></smalL></p>
							</div>
							<div class='col-md-7'>
								<img width="90%" style="object-fit: fill;" src="https://d33wubrfki0l68.cloudfront.net/965b3d00a65c84c83bed88b2e70f1a3baff767cc/801b5/img/banner-image.png" />
							</div>
						</div>
					</div>
				</section>


				<section data-markdown>
					<script type="text/template">
### D<span style="text-transform: lowercase;">emo</span>

<a href="https://play.openpolicyagent.org/">play.openpolicyagent.org</a>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### D<span style="text-transform: lowercase;">emo</span>

Input:

<pre style="display: block; width: 100%;"><code class="language-json">{
  "session": {
    "login": "natalia12",
    "teams": ["Platform"],
    "member": true
  }
}</code></pre>
					</script>
				</section>

				<section>
					<h3>D<span style="text-transform: lowercase;">emo</span></h3>

Input:

<pre style="display: block; width: 100%;"><code class="language-json" style="font-size:20px;">{
  "request": {
    "remote_ip": "string - IP of the user trying to log in",
    "timestamp_ns": "number - current Unix timestamp in nanoseconds"
  },
  "session": {
    "login": "string - username of the user trying to log in",
    "member": "boolean - is the user a member of the account",
    "name": "string - full name of the user trying to log in - may be empty",
    "teams": ["string - names of teams the user is a member of"]
  }
}</pre></code>
				</section>

				<section data-markdown>
					<script type="text/template">
### D<span style="text-transform: lowercase;">emo</span>

Policy:

<pre style="display: block; width: 100%;"><code class="language-js">package talk_opa
teams := input.session.teams

admin { teams[_] == "Platform" }
allow { teams[_] == "Engineering" }
deny  { not input.session.member }</code></pre>
					</script>
				</section> 

				<section data-markdown>
					<script type="text/template">
### R<span style="text-transform: lowercase;">ego</span>

- Readable and easier for non-programmers*;

- Declarative;

- Inspired by [Datalog](https://en.wikipedia.org/wiki/Datalog);

- Safe and guaranteed to terminate.
					</script>
				</section>
				<!-- Supports arbitrarily nested documents (e.g. graphs); -->

				<!-- section data-markdown>
					<script type="text/template">
### R<span style="text-transform: lowercase;">ego</span>

- You can run the custom code safe:
  - non Turing-complete - no loops or conditionals;
  - guaranteed to terminate;
  - ensures that queries are correct<br />and unambiguous.
					</script>
				</section -->

							<section data-markdown>
					<script type="text/template">
### R<span style="text-transform: lowercase;">ego</span>

- Build-in functions ([docs](https://www.openpolicyagent.org/docs/latest/policy-reference/#built-in-functions)):<br /> `sort`, `array.concat`, `json.filter`, `strings.any_suffix_match`, ...;
- You can add your own functions.
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### D<span style="text-transform: lowercase;">emo</span>

Data - global values:

<pre style="display: block; width: 100%;"><code class="language-json">{
  "maintenance": false,
  "region": "eu-west-1"
}</code></pre>
					</script>
				</section>

				<!-- section data-markdown>
					<script type="text/template">
### O<span style="text-transform: lowercase;">pen</span> P<span style="text-transform: lowercase;">olicy</span> A<span style="text-transform: lowercase;">gent</span>

Open Policy Agent (OPA) generates policy decisions by evaluating the query input against policies and data.
					</script>
				</section --> 

				<!-- section data-markdown>
					<script type="text/template">
### R<span style="text-transform: lowercase;">ego</span>

Input:

```json
{
  "request": {
    "remote_ip": "string - IP of the user trying to log in",
    "timestamp_ns": "number - current Unix timestamp in nanoseconds"
  },
  "session": {
    "login": "string - username of the user trying to log in",
    "member": "boolean - is the user a member of the account",
    "name": "string - full name of the user trying to log in - may be empty",
    "teams": ["string - names of teams the user is a member of"]
  }
}
```
					</script>
				</section -->

				<section data-markdown>
					<script type="text/template">
### D<span style="text-transform: lowercase;">emo</span>

More complex examples:

- [Login &amp; time restriction](https://docs.spacelift.io/concepts/policy/login-policy#restricting-access-to-specific-circumstances)
- [Approve](https://docs.spacelift.io/concepts/policy/approval-policy#role-based-approval)
- [Plan](https://docs.spacelift.io/concepts/policy/terraform-plan-policy#organizational-rule-enforcement) 
- [rule for conftest](https://github.com/open-policy-agent/conftest)
- .. [can get complex](https://github.com/spacelift-io/spacelift-policies-example-library/blob/main/plan/infracost-monthly-cost-restriction.rego)
					</script>
				</section>
				<!--
deny["wojciech12"] {
    input.spacelift.commit.author == "wojciech12"
}
				-->

				<!-- 
					- [Trigger](https://docs.spacelift.io/concepts/policy/trigger-policy#interdependent-stacks)
				-->

				<section data-markdown>
					<script type="text/template">
### Y<span style="text-transform: lowercase;">our app/tool</span>

<img src="img/opa_two_modes.png" width="50%" />

<p><small>Library: Golang &amp; Wasm (experimental).</small></p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### G<span style="text-transform: lowercase;">olang & </span>OPA

- Golang lib - embed OPA
- Golang SDK - high level API

<p><small>See <a href="https://www.openpolicyagent.org/docs/latest/integration/#comparison">docs</a>.</small></p> 
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### G<span style="text-transform: lowercase;">olang & </span>OPA

Let's dive into the code.
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### G<span style="text-transform: lowercase;">olang & </span>OPA

Security:

```golang
var (
	unsafeBuiltins = map[string]struct{}{
		"http.send":         {},
		"opa.runtime":       {},
		"rego.parse_module": {},
		"time.now_ns":       {},
		"trace":             {},
	}
)
```

```golang
rego.UnsafeBuiltins(unsafeBuiltins)
```
					</script>
				</section>
				<!-- https://www.styra.com/blog/linting-rego-with-rego/ -->

				<section data-markdown>
					<script type="text/template">
### G<span style="text-transform: lowercase;">olang & </span>OPA

Custom functions:

```golang
r := rego.New(
	rego.Query(`x = hello("natalia")`),
	rego.Function1(
		&rego.Function{
			Name: "hello",
			Decl: types.NewFunction(types.Args(types.S), types.S),
		},
		func(_ rego.BuiltinContext, a *ast.Term) (*ast.Term, error) {
			if str, ok := a.Value.(ast.String); ok {
				return ast.StringTerm("hello, " + string(str)), nil
			}
			return nil, nil
		}),
)
```
					</script>
				</section>


				<section data-markdown>
					<script type="text/template">
### L<span style="text-transform: lowercase;">essons learnt</span>

Open Policy Agent:

- easily integrates with Golang
- implement policy-as-a-code in a safe way
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### L<span style="text-transform: lowercase;">essons learnt</span>

Rego requires time to master:

1. [Policy workbench with samples](https://docs.spacelift.io/concepts/policy#policy-workbench-in-practice)
2. [examples](https://github.com/spacelift-io/spacelift-policies-example-library) and [docs](https://docs.spacelift.io/concepts/policy)
3. [policy testing](https://www.openpolicyagent.org/docs/latest/policy-testing/)
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### L<span style="text-transform: lowercase;">essons learnt</span>

Styra, for example, provides an interactive builder:

- [Policy Builder](https://docs.styra.com/policies/policy-authoring/policy-builder/use-policy-builder)
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### L<span style="text-transform: lowercase;">essons learnt</span>

Watch out:

- You load input to memory to evaluate policy
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### E<span style="text-transform: lowercase;">cosystem</span>

<img src="img/ecosystem.png" width="80%" />
					</script>
				</section><!-- small><p><a href="https://www.openpolicyagent.org/docs/latest/ecosystem/">docs</a></p></small -->


				<section data-markdown>
					<script type="text/template">
### DX, P<span style="text-transform: lowercase;">latform &amp; infa teams</span>

- Enforce best practices</li>
- Encourage other teams to contribute

<p><small>see e.g, <a href="https://www.conftest.dev/">conftest</a></small></p>
					</script>
				</section>

				<!-- section data-markdown>
					<script type="text/template">
<img src="img/spacelift_logo.svg" width="40%" />

Slides and code:<br />[github.com/wojciech12](https://github.com/wojciech12/talk_policies_for_your_apps_with_OpenPolicyAgent)

<p><small><b>Wojciech Barczynski</b><br/><i>wojciechb@spacelift.io</i></small></p>
					</script>
				</section -->

				<section data-markdown>
					<script type="text/template">
<img src="img/spacelift_logo.svg" width="40%" />

<b>Thank you. Questions?</b><br />

<p><small><b>Wojciech Barczynski</b><br/><i>wojciechb@spacelift.io</i><br />
<br />
<br />github:<br /><a href="https://github.com/wojciech12/talk_policies_for_your_apps_with_OpenPolicyAgent">wojciech12/talk_policies_for_your_apps_with_OpenPolicyAgent</a></small></p>
					</script>
				</section>


				<section data-markdown>
					<script type="text/template">
<img src="img/spacelift_logo.svg" width="40%" />

<b>Hiring</b><br />Frontend and (Go) Backend developers<br />with a passion for building tools<br /> for other engineers.
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
# B<span style="text-transform: lowercase;">ackup slides</span>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
### C<span style="text-transform: lowercase;">heckers &amp; linters</span>

Kuberentes, Terraform, and many others:

- [conftest](https://www.conftest.dev/)
- [kics.io](https://github.com/Checkmarx/kics/blob/master/docs/queries.md)
					</script>
				</section>
				<!--
				https://www.checkov.io/
				-->

				<section data-markdown>
					<script type="text/template">
### A<span style="text-transform: lowercase;">lternatives</span>

- [cuelang](https://cuelang.org/)
- [kyverno](https://kyverno.io/)
- [Sentinel](https://docs.hashicorp.com/sentinel/concepts/policy-as-code)
					</script>
				</section>				

				<!--
					https://cuelang.org/
				-->
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
